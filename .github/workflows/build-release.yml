name: Build & Release APK

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    name: Build Release APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true
      
      - name: Flutter Doctor
        run: flutter doctor -v
      
      - name: Install Dependencies
        run: flutter pub get
      
      - name: Decode Keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_FILE_BASE64 }}
        run: |
          echo "$KEYSTORE_BASE64" | base64 -d > android/app/release.keystore
      
      - name: Build Release APKs
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          flutter build apk --release --split-per-abi \
            --target-platform android-arm,android-arm64
      
      - name: Get Version
        id: version
        run: |
          if [ "${{ github.ref_type }}" == "tag" ]; then
            VERSION="${{ github.ref_name }}"
          else
            VERSION="v1.5.0"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Prepare Release Files
        run: |
          mkdir -p release-apks
          cp build/app/outputs/flutter-apk/app-arm64-v8a-release.apk release-apks/ZedSecure-${{ steps.version.outputs.version }}-arm64-v8a.apk
          cp build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk release-apks/ZedSecure-${{ steps.version.outputs.version }}-armeabi-v7a.apk
      
      - name: Upload ARM64 APK
        uses: actions/upload-artifact@v4
        with:
          name: ZedSecure-arm64-v8a
          path: release-apks/ZedSecure-${{ steps.version.outputs.version }}-arm64-v8a.apk
      
      - name: Upload ARMv7 APK
        uses: actions/upload-artifact@v4
        with:
          name: ZedSecure-armeabi-v7a
          path: release-apks/ZedSecure-${{ steps.version.outputs.version }}-armeabi-v7a.apk
      
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release-apks/ZedSecure-${{ steps.version.outputs.version }}-arm64-v8a.apk
            release-apks/ZedSecure-${{ steps.version.outputs.version }}-armeabi-v7a.apk
          body: |
            ## ZedSecure VPN ${{ steps.version.outputs.version }}
            
            ### Downloads
            
            | Architecture | File | Devices |
            |-------------|------|---------|
            | ARM64-v8a | `ZedSecure-${{ steps.version.outputs.version }}-arm64-v8a.apk` | Modern devices (2015+) - Recommended |
            | ARMv7a | `ZedSecure-${{ steps.version.outputs.version }}-armeabi-v7a.apk` | Older devices |
            
            ### What's New in v1.5.0
            
            - iOS-style UI redesign with glassmorphism effects
            - Dynamic Island connection status display
            - Ring animation connect button
            - SVG country flags with real location detection
            - FluxTun custom TUN library integration
            - ARMv7 architecture support
            - Improved socket protection
            - Real country detection via Cloudflare
            
            ### Installation
            
            1. Download the appropriate APK for your device
            2. Enable "Install from Unknown Sources" in Android settings
            3. Install the APK
            4. Grant VPN and notification permissions
            
            ---
            
            **Telegram**: https://t.me/CluvexStudio
            
            Developed by CluvexStudio
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
